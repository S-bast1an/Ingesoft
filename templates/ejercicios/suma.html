{% extends "base.html" %}

{% block title %}Ejercicios de Suma{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('primaria', tema='operaciones-basicas') }}">Operaciones Básicas</a></li>
            <li class="breadcrumb-item active">Ejercicios de Suma</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-plus text-primary me-2"></i>
                        Ejercicios de Suma - Nivel {{ nivel }}
                    </h4>
                    <div>
                        <button id="reiniciar-progreso" class="btn btn-warning btn-sm me-2">
                            <i class="fas fa-redo me-1"></i>
                            Reiniciar Progreso
                        </button>
                        <span class="badge bg-primary">{{ ejercicios_completados }} ejercicios completados</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="ejercicio-actual" class="text-center py-4">
                        <h2 class="display-4 mb-4">
                            <span id="num1">?</span> + <span id="num2">?</span> = ?
                        </h2>
                        <div class="mb-4">
                            <input type="number" id="respuesta-usuario" class="form-control form-control-lg text-center" placeholder="Tu respuesta">
                        </div>
                        <button id="verificar" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-check me-2"></i>Verificar
                        </button>
                    </div>

                    <div id="resultado" class="alert d-none text-center">
                        <!-- El resultado se mostrará aquí -->
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog text-primary me-2"></i>
                        Configuración
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="ejercicios-requeridos" class="form-label">Ejercicios requeridos para cambiar de nivel</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ejercicios-requeridos" 
                                   min="1" max="10" value="5">
                            <button class="btn btn-primary" id="guardar-config">
                                <i class="fas fa-save me-1"></i>Guardar
                            </button>
                        </div>
                        <small class="text-muted">
                            Este número de ejercicios correctos consecutivos serán necesarios para subir de nivel.
                            El mismo número de errores consecutivos hará que bajes de nivel.
                        </small>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line text-success me-2"></i>
                        Tu Progreso
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Nivel Actual</label>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-success" 
                                 role="progressbar" 
                                 style="width: {{ nivel_porcentaje }}%">
                                Nivel {{ nivel }} de 3
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precisión</label>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-primary" 
                                 role="progressbar" 
                                 style="width: {{ precision_porcentaje }}%">
                                {{ "%.1f"|format(precision_porcentaje) }}%
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <p class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            {{ aciertos }} aciertos de {{ ejercicios_completados }} ejercicios
                        </p>
                        <small class="text-muted">
                            {% if nivel < 3 %}
                            Necesitas 5 ejercicios correctos consecutivos para subir de nivel
                            {% else %}
                            ¡Has alcanzado el nivel máximo!
                            {% endif %}
                        </small>
                        <small class="text-muted d-block mt-2">
                            {% if nivel > 1 %}
                            4 fallos consecutivos harán que bajes de nivel
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        Consejos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="tips">
                        {% if nivel == 1 %}
                        <p><i class="fas fa-info-circle text-primary me-2"></i>Cuenta con los dedos si necesitas ayuda.</p>
                        <p><i class="fas fa-info-circle text-primary me-2"></i>Visualiza los números como grupos de objetos.</p>
                        {% elif nivel == 2 %}
                        <p><i class="fas fa-info-circle text-primary me-2"></i>Suma primero las unidades, luego las decenas.</p>
                        <p><i class="fas fa-info-circle text-primary me-2"></i>Recuerda llevar la cuenta cuando sumes más de 10.</p>
                        {% else %}
                        <p><i class="fas fa-info-circle text-primary me-2"></i>Alinea los números por unidades, decenas y centenas.</p>
                        <p><i class="fas fa-info-circle text-primary me-2"></i>Suma columna por columna, empezando por la derecha.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let ejercicioActual = null;
let tiempoInicio = null;
const nivelActual = Number("{{ nivel|int }}");

function mostrarError(mensaje) {
    const resultadoDiv = document.getElementById('resultado');
    resultadoDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
    resultadoDiv.classList.add('alert-danger');
    resultadoDiv.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${mensaje}`;
}

function mostrarMensajeAyuda(mensaje) {
    if (!mensaje) return;
    
    const resultadoDiv = document.getElementById('resultado');
    resultadoDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
    resultadoDiv.classList.add('alert-info');
    resultadoDiv.innerHTML = `
        <i class="fas fa-info-circle me-2"></i>
        <span class="mensaje-ayuda">${mensaje}</span>
    `;
}

function actualizarEstadisticas(data) {
    // Actualizar nivel
    const tituloNivel = document.querySelector('.card-header h4');
    tituloNivel.innerHTML = `<i class="fas fa-plus text-primary me-2"></i>Ejercicios de Suma - Nivel ${data.nivel}`;
    
    // Actualizar contador de ejercicios
    const contadorEjercicios = document.querySelector('.badge.bg-primary');
    contadorEjercicios.textContent = `${data.ejercicios_completados} ejercicios completados`;
    
    // Actualizar barras de progreso
    const nivelProgressBar = document.querySelector('.progress-bar.bg-success');
    nivelProgressBar.style.width = `${(data.nivel / 3) * 100}%`;
    nivelProgressBar.textContent = `Nivel ${data.nivel} de 3`;
    
    const precisionProgressBar = document.querySelector('.progress-bar.bg-primary');
    const precision = data.ejercicios_completados > 0 ? (data.aciertos / data.ejercicios_completados * 100) : 0;
    precisionProgressBar.style.width = `${precision}%`;
    precisionProgressBar.textContent = `${precision.toFixed(1)}%`;
    
    // Actualizar texto de aciertos
    const textoAciertos = document.querySelector('.text-center p.mb-2');
    textoAciertos.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${data.aciertos} aciertos de ${data.ejercicios_completados} ejercicios`;
}

function actualizarEjercicio(ejercicio) {
    if (!ejercicio || !ejercicio.num1 || !ejercicio.num2) {
        mostrarError('Error al cargar el ejercicio. Intenta recargar la página.');
        return false;
    }
    
    ejercicioActual = ejercicio;
    document.getElementById('num1').textContent = ejercicio.num1;
    document.getElementById('num2').textContent = ejercicio.num2;
    document.getElementById('respuesta-usuario').value = '';
    document.getElementById('resultado').classList.add('d-none');
    document.getElementById('respuesta-usuario').focus();
    tiempoInicio = Date.now();
    return true;
}

function cargarNuevoEjercicio() {
    fetch('/api/ejercicios/suma')
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al obtener ejercicios');
            }
            return response.json();
        })
        .then(ejercicios => {
            if (!ejercicios || !ejercicios.length) {
                throw new Error('No se recibieron ejercicios válidos');
            }
            actualizarEjercicio(ejercicios[0]);
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarError('Error al cargar ejercicios. Por favor, recarga la página.');
        });
}

function reiniciarProgreso() {
    return new Promise((resolve, reject) => {
        fetch('/api/ejercicios/suma/reiniciar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al reiniciar progreso');
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error('Fallo al reiniciar progreso');
            }
            if (!data.ejercicios || !data.ejercicios.length) {
                throw new Error('No se recibieron ejercicios nuevos');
            }
            // Actualizar el ejercicio actual con el primer ejercicio nuevo
            actualizarEjercicio(data.ejercicios[0]);
            resolve(data);
        })
        .catch(error => {
            console.error('Error:', error);
            reject(error);
        });
    });
}

function verificarRespuesta(respuestaUsuario, tiempoTranscurrido) {
    if (!ejercicioActual) {
        mostrarError('No hay ejercicio activo');
        return;
    }

    fetch('/api/ejercicios/suma/verificar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            respuesta: respuestaUsuario,
            respuesta_correcta: ejercicioActual.respuesta,
            tiempo: tiempoTranscurrido
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error al verificar respuesta');
        }
        return response.json();
    })
    .then(data => {
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info');
        
        if (data.correcto) {
            resultadoDiv.classList.add('alert-success');
            resultadoDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ¡Correcto! Muy bien hecho.
            `;
        } else {
            resultadoDiv.classList.add('alert-danger');
            resultadoDiv.innerHTML = `
                <i class="fas fa-times-circle me-2"></i>
                La respuesta correcta era ${ejercicioActual.respuesta}. ¡Sigue intentando!
            `;
        }

        // Mostrar mensaje de ayuda si existe
        if (data.mensaje_ayuda) {
            setTimeout(() => mostrarMensajeAyuda(data.mensaje_ayuda), 2000);
        }

        // Actualizar estadísticas
        actualizarEstadisticas(data);

        // Si cambió el nivel, actualizar los consejos
        if (data.nivel_cambio) {
            setTimeout(() => window.location.reload(), 3000);
        } else {
            // Cargar nuevo ejercicio después de 2 segundos
            setTimeout(cargarNuevoEjercicio, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarError('Error al verificar la respuesta. Por favor, intenta de nuevo.');
    });
}

document.getElementById('reiniciar-progreso').addEventListener('click', function() {
    if (confirm('¿Estás seguro de que quieres reiniciar todo tu progreso? Esta acción no se puede deshacer.')) {
        // Deshabilitar el botón mientras se procesa
        const boton = this;
        boton.disabled = true;
        boton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Reiniciando...';
        
        reiniciarProgreso()
            .then(data => {
                // Recargar la página para actualizar todas las estadísticas
                window.location.reload();
            })
            .catch(error => {
                mostrarError('Error al reiniciar. Por favor, intenta de nuevo.');
                // Restaurar el botón
                boton.disabled = false;
                boton.innerHTML = '<i class="fas fa-redo me-1"></i>Reiniciar Progreso';
            });
    }
});

document.getElementById('verificar').addEventListener('click', function() {
    const respuestaUsuario = parseInt(document.getElementById('respuesta-usuario').value);
    
    if (isNaN(respuestaUsuario)) {
        alert('Por favor, ingresa un número');
        return;
    }

    const tiempoFin = Date.now();
    const tiempoTranscurrido = (tiempoFin - tiempoInicio) / 1000;  // Convertir a segundos

    verificarRespuesta(respuestaUsuario, tiempoTranscurrido);
});

document.getElementById('respuesta-usuario').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('verificar').click();
    }
});

document.getElementById('guardar-config').addEventListener('click', function() {
    const ejerciciosRequeridos = parseInt(document.getElementById('ejercicios-requeridos').value);
    if (isNaN(ejerciciosRequeridos) || ejerciciosRequeridos < 1 || ejerciciosRequeridos > 10) {
        alert('Por favor ingresa un número entre 1 y 10');
        return;
    }

    fetch('/api/ejercicios/suma/configurar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ejercicios_requeridos: ejerciciosRequeridos,
            nivel: nivelActual
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Mostrar mensaje de éxito
            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.classList.remove('d-none', 'alert-danger');
            resultadoDiv.classList.add('alert-success');
            resultadoDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                Configuración guardada: ${ejerciciosRequeridos} ejercicios requeridos para cambiar de nivel
            `;

            // Actualizar los mensajes informativos
            document.querySelectorAll('.text-muted').forEach(elem => {
                if (elem.textContent.includes('ejercicios correctos')) {
                    if (nivelActual < 3) {
                        elem.textContent = `Necesitas ${ejerciciosRequeridos} ejercicios correctos consecutivos para subir de nivel`;
                    }
                } else if (elem.textContent.includes('fallos consecutivos')) {
                    if (nivelActual > 1) {
                        elem.textContent = `${ejerciciosRequeridos} fallos consecutivos harán que bajes de nivel`;
                    }
                }
            });
        } else {
            throw new Error(data.error || 'Error desconocido al guardar la configuración');
        }
    })
    .catch(error => {
        console.error('Error detallado:', error);
        // Mostrar error en la interfaz
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.classList.remove('d-none', 'alert-success');
        resultadoDiv.classList.add('alert-danger');
        resultadoDiv.innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>
            Error al guardar la configuración: ${error.message}
        `;
    });
});

// Cargar el primer ejercicio al iniciar
cargarNuevoEjercicio();
</script>
{% endblock %} 